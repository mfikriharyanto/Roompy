{% extends "base.html" %}

{% load static %}

	{% block title %}Topics{% endblock %}

    {% block content %}
        <div class="container p-4">
            <h2 class="text-center font-weight-bold">Trending Topic</h2>
            {% if user.is_authenticated %}
                <a href="/topics/create" class="btn btn-primary">Create Topic</a>
            {% endif %}
        </div>
        <div class="container-fluid">
			<table class="table table-striped">
				<thead>
					<tr>
                        <th scope="col"></th>
						<th scope="col">topics</th>
						<th scope="col">action</th>
					</tr>
				</thead>
				<tbody id='all_topic'>
                    {% csrf_token %}
				</tbody>
			</table>
		</div>
        
        
    {% endblock %}

	{% block script %}
    <script>
        {% if user.is_authenticated %}
            var userid = {{user.id}}
        {% else %}
            var userid = -1
        {% endif %}

        $(document).ready(function() {
        $.ajax({
        type: "GET",
        url: "/api/topics/trending-topics",
        success: async function (response) {
            $.each(response, function(index, value) {
                console.log(response)

                topic =
                `<tr id=${value.id}>
                    <th scope="row">${index+1}</th>
                    <td>${value.name} (${value.total_followers})</td>
                </tr>`;
                $("#all_topic").append(topic);
            });
            $.each(response, function(index, value) {
            var csrftoken = $("[name=csrfmiddlewaretoken]").val();
            if (value.topic_followers.includes(userid)) {
                is_followed = `<td><button type="button" id="unfollow-${value.id}" class="btn btn-secondary">Unfollow</button></td>`;
                $(`#${value.id}`).append(is_followed);
                $(`#unfollow-${value.id}`).click(function() {
                $.ajax({
                    type: "POST",
                    headers:{
                    "X-CSRFToken": csrftoken
                },
                url: "/api/topics/"+`${value.id}`+"/unfollow",
                success: function (response) {
                    location.reload();
                },
                error: function(response) {
                if (response.status == 403) {
                    alert("You're not logged in. You must login to follow topic.");
                } else {
                    var err = JSON.parse(response.responseText);
                    alert(err.message);
                }
                }
                });
            });
            } else {
            is_followed = `<td><button type="button" id="follow-${value.id}" class="btn btn-primary">Follow</button></td>`;
            $(`#${value.id}`).append(is_followed);
            $(`#follow-${value.id}`).click(function() {
                $.ajax({
                type: "POST",
                headers:{
                    "X-CSRFToken": csrftoken
                },
                url: "/api/topics/"+`${value.id}`+"/follow",
                success: function (response) {
                    location.reload();
                },
                error: function(response) {
                if (response.status == 403) {
                    alert("You're not logged in. You must login to follow topics.");
                } else {
                    var err = JSON.parse(response.responseText);
                    alert(err.message);
                }
                }
                });
            });
            }
        });
        },
        error: function() {
        alert("Failed to get top users. Please try again later.")
        location.reload()
        }
    });
    });

        // $.ajax({
        //     method:'GET',
        //     url:"/api/topics/",
        //     success:function(response){
        //         topics = response
        //         console.log(topics)
        //         console.log(followed)
        //         buildTable(topics)
        //         console.log('user logged: '+ userid)
        //     }
        // })

        // function buildTable(data){
        //     var table = document.getElementById('all_topic')
        //     var csrftoken = $("[name=csrfmiddlewaretoken]").val();

        //     for (var i = 0; i < data.length; i++){
        //         if (!data[i].topic_followers.includes(userid)){
        //             var row = `<tr>
        //                     <td>${data[i].name}</td>
        //                     <td><button type="button" id="follow-${data[i].id}" class="btn btn-primary">follow</button></td>
        //                 </tr>`

        //             $(`#follow-${data[i].id}`).click(function() {
        //                 $.ajax({
        //                 type: "POST",
        //                 headers:{
        //                     "X-CSRFToken": csrftoken
        //                 },
        //                 url: `/api/topics/${data[i].id}/follow`,
        //                 success: function (response) {
        //                     console.log(response)
        //                     location.reload();
        //                 },
        //             });
        //             });
        //         }else{
        //             var row = `<tr>
        //                     <td>${data[i].name}</td>
        //                     <td><button type="button" id="unfollow-${data[i].id}" class="btn btn-danger">Unfollow</button></td>
        //                 </tr>`

        //             $(`#unfollow-${data[i].id}`).click(function() {
        //                 $.ajax({
        //                 type: "POST",
        //                 headers:{
        //                     "X-CSRFToken": csrftoken
        //                 },
        //                 url: `/api/topics/${data[i].id}/unfollow`,
        //                 success: function (response) {
        //                     console.log(response)
        //                     location.reload();
        //                 },
        //             });
        //             });
        //         }
                
        //         table.innerHTML += row

        //     }
        // }
    </script>
	{% endblock script %}